<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="/imgs/favicon.png">
      <meta charset="utf-8">
  <script type="importmap">
      {
	"imports": {
	  "three": 
	      "https://unpkg.com/three@v0.154.0/build/three.module.js",
	  "three/addons/":
	      "https://unpkg.com/three@v0.154.0/examples/jsm/"
	}
      }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" 
           integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" 
           crossorigin="anonymous">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@latest"></script>

<style>
  .dlgFrame
  {
    border-radius: 16px 16px 16px 16px;
    box-shadow: 3px 3px 5px #535353;
    background: lightYellow;
  }

</style>
</head>
<!--////////////////////////  END HEADERS ///////////////////-->
<script type=module>
  import  {THREE, GUI, loader, scene, camera, renderer} from "./init.js" ;
  import {Plane} from "./plane.js" ;
  import {light, dlight, lightGUI} from  "./lights.js" ;
  import {setColor, setPos, measure, saveScene} from "./util.js" ;
//  import {OrbitControls} from 'three/addons/controls/OrbitControls'

  let plane = await Plane () ;
  scene.add (plane) ;
  scene.add (light); 
  scene.add (dlight);
//  getTensor () ;
  genImage (2870) ;
//  scene.add (new THREE.AxesHelper(40)) ;


// Functions 
/////////////////////////////////////////////

function rotations (tmax, n) {
 let dt = tmax / n ;
 let rot = [] ;
 for (let i = 0; i < n ; i++)
 for (let j = 0; j < n ; j++)
 for (let k = 0; k < n ; k++)
    rot.push ({x: i*dt , y: j*dt, z: k*dt}) ;
 return (rot) ;
} // end rotations

function genImage (i) {
     render () ;
     sleep (100).then (rotate (i)) 
} // genImages

function rotate (i) { 
  var j = i ;
  return (
      () => { 
	 let str = format (plane.rotation.x) +
	           format (plane.rotation.y) +
		   format (plane.rotation.z) ;

         let fname =  "p" + str + ".png"; 
         saveScene (fname); 
//	 console.log("Saving " + fname) ;
	 j = j + 1 ;

         let n = 45, tmax = 45 ; 
	 if (j < n*n*n)  {
	    let rots = rotations (tmax, n) ;  // bit yuk that we repeat this here
            plane.rotation.x = rots[j].x ;
            plane.rotation.y = rots[j].y ;
            plane.rotation.z = rots[j].z ;

            genImage (j) ; // next rotation
	 }}) ;
} // end rotate

function format (num) {
 let s = num.toFixed(0) ;
 if (num < 10) s = "0" + s ;
 return (s) ;
}

function sleep (ms) {  // returns a promise
 //console.log("Sleeping");
 return new Promise (resolve => setTimeout (resolve, ms)) ;
}

function animate(){
    requestAnimationFrame (animate);
    // some rotation ito be added
    renderer.render (scene, camera);
  }

function render() {
    requestAnimationFrame (render);
    renderer.render (scene, camera);
}

function getTensor () {
  const im = new Image()
  im.src = "output/p000.png"
  im.onload = () => {
      let nch = 1 ;
      const a = tf.browser.fromPixels(im, nch)
      a.print() ;
      console.log("using TensorFlow: ", a.flatten())
  }
}

function resize_canvas( x = 512, y = 512 ) {
  // not giving good result
  var  canvas = document.getElementsByTagName('canvas')[0];
  canvas.width = x;
  canvas.height = y;
  camera.aspect = canvas.clientWidth / canvas.clientHeight;
  camera.updateProjectionMatrix();
}

document.getElementById("setLight").addEventListener(
       "click",function(){
         setColor(light).showModal();
       });
document.getElementById("setCamPos").addEventListener(
       "click",function(){
         setPos(camera).showModal();
       });
</script>

<!--      WEB PAGE DOM ELEMENTS  ------>
<body>
  <div class=container>
    <h2>Payload Thermal Model </h2>
   <button id="setLight">setLight</button>
   <button id="setCamPos">setCamPos</button>
  </div>
</body>
</html>
